{% extends "base.html" %}

{% block title %}Gr√°ficos - Or√ßaF√°cil{% endblock %}

{% block content %}
<div class="container">
    <h1 class="text-center mb-4">üìä Or√ßaF√°cil - Gr√°ficos</h1>

    <div class="row">
        <!-- Pizza -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header text-center">
                    <h5 class="mb-0"><i class="fas fa-chart-pie me-2"></i>Receitas vs Despesas</h5>
                </div>
                <div class="card-body">
                    <canvas id="pieChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Barras -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header text-center">
                    <h5 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Despesas por Categoria</h5>
                </div>
                <div class="card-body">
                    <canvas id="barChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Linhas -->
        <div class="col-md-4 mb-4">
            <div class="card">
                <div class="card-header text-center">
                    <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Evolu√ß√£o Mensal</h5>
                </div>
                <div class="card-body">
                    <canvas id="lineChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", async () => {
    console.log("üìà Carregando gr√°ficos...");

    try {
        const res = await fetch("/api/charts/data");
        const data = await res.json();

        // --- Gr√°fico Pizza ---
        const pieCtx = document.getElementById("pieChart");
        if (data.pie && data.pie.length) {
            new Chart(pieCtx, {
                type: "doughnut",
                data: {
                    labels: data.pie.map(p => p.type),
                    datasets: [{
                        data: data.pie.map(p => p.total),
                        backgroundColor: ["#28a745", "#dc3545"]
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });
        } else {
            pieCtx.parentElement.innerHTML = "<p class='text-muted text-center'>Sem dados suficientes</p>";
        }

        // --- Gr√°fico Barras ---
        const barCtx = document.getElementById("barChart");
        if (data.bar && data.bar.length) {
            new Chart(barCtx, {
                type: "bar",
                data: {
                    labels: data.bar.map(b => b.category),
                    datasets: [{
                        label: "Total (R$)",
                        data: data.bar.map(b => b.total),
                        backgroundColor: "#17a2b8"
                    }]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    }
                }
            });
        } else {
            barCtx.parentElement.innerHTML = "<p class='text-muted text-center'>Sem despesas registradas</p>";
        }

        // --- Gr√°fico Linhas ---
        const lineCtx = document.getElementById("lineChart");
        if (data.line && data.line.length) {
            new Chart(lineCtx, {
                type: "line",
                data: {
                    labels: data.line.map(l => l.month),
                    datasets: [
                        {
                            label: "Receitas",
                            data: data.line.map(l => l.revenue),
                            borderColor: "#28a745",
                            fill: false,
                            tension: 0.3
                        },
                        {
                            label: "Despesas",
                            data: data.line.map(l => l.expense),
                            borderColor: "#dc3545",
                            fill: false,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    scales: {
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { position: "bottom" }
                    }
                }
            });
        } else {
            lineCtx.parentElement.innerHTML = "<p class='text-muted text-center'>Sem dados mensais</p>";
        }

        console.log("‚úÖ Gr√°ficos carregados!");
    } catch (err) {
        console.error("Erro ao carregar gr√°ficos:", err);
        document.querySelector(".container").insertAdjacentHTML("beforeend",
            "<div class='alert alert-danger mt-3'>Erro ao carregar dados dos gr√°ficos.</div>");
    }
});
</script>
{% endblock %}
